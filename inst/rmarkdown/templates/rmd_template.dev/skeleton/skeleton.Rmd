---
title: "rcell2: Workflow Template"
author: "Nicolás Méndez"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_float:
      collapsed: false
    toc_depth: 4
    number_sections: false
    smooth_scroll: false
    code_folding: hide
  pdf_document:
    latex_engine: xelatex
    toc: true
    toc_depth: 4
    number_sections: true
date: "`r format(Sys.time(), '%d %B, %Y')`"
urlcolor: blue
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "output/renders") })
bibliography: references.bib
---

<!-- Download a copy of this file with rcell2::get_workflow_template() -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T,
                      message = F, 
                      # https://yihui.org/knitr/options/#chunk-options
                      out.width = "100%")
                      # https://stackoverflow.com/a/66753995
                      # tidy.opts = list(width.cutoff = 60), tidy = TRUE)
knitr::opts_knit$set(root.dir = here::here())  #, base.dir = here::here())

library(rcell2)  # this package you are checking out :)
# library(rcell2.cellid)  # Advanced functionality: run CellID entirely in R.
# library(rcell2.magick)  # Advanced functionality: filter data using Shiny and preview images with Magick.

# library(magick)  # if you need it

library(tidyverse)  # import numpy as np (?)
```

## Friendly reminders

- **Read the help page** of functions before using them. Open help pages with R's `?` (e.g. `?load_cell_data`).
- **Read the README**.md at rcell2's [GitHub repo](https://github.com/darksideoftheshmoo/rcell2/).

## Quick segmentation example

This code runs Cell-ID on an example image dataset, using the default parameters,
and loads the output into R (including cell boundaries).

A full explanation and walkthroug of this process is available
in the notebook template of the `rcell2.cellid` package.

Execute the following to install the package and open the template:

```{r}
if(!requireNamespace("rcell2.cellid")) remotes::install_github("darksideoftheshmoo/rcell2-cellid")
rcell2.cellid::get_workflow_template_cellid()
```


```{r, eval=F}
if(!requireNamespace("remotes")) install.packages("remotes")
if(!requireNamespace("rcell2.examples")) remotes::install_github("darksideoftheshmoo/rcell2.examples")
data.dir <- system.file("extdata/sample_datasets/sample_time_series/", package = "rcell2.examples")

cellid.args <- rcell2.cellid::arguments(path = data.dir)

# Cell-ID has already been run.
# cell2.out <-
#   rcell2.cellid::cell2(arguments = cellid.args,
#                        output_coords_to_tsv = T,
#                        check_fail = T)

cell.data <- rcell2.cellid::cell.load.alt(path = data.dir)

cell.boundaries <- 
  rcell2::cell.load.boundaries(data.source = "masks.tsv",
                               arguments = cellid.args,
                               pixel.type = "b"
                               )
```

## Preamble

### Image file names

Images are assumed to be in a single directory, and have names with identifiers for:

* Imaging channel (birghtfield, transmission, fluorescence, z-slice, etc.).
* Microscope position (*pos*).
* Time (*t.frame*, optional).

Cell-ID uses the first 3 letters of the file name to group imaging channels.
**This is mandatory**. If your image set does not conform initially, it can be
renamed (or symlinked) using rcell2's `rename_mda`, with custom arguments.

For example, file names for a 2-position time course experiment
are expected to have the following appearance:

```
BF_Position001_time01.tif
BF_Position001_time02.tif
TFP_Position001_time01.tif
TFP_Position001_time02.tif
YFP_Position001_time01.tif
YFP_Position001_time02.tif
BF_Position002_time01.tif
BF_Position002_time02.tif
TFP_Position002_time01.tif
TFP_Position002_time02.tif
YFP_Position002_time01.tif
YFP_Position002_time02.tif
```

The `rcell2` packages rely on regular expressions to gather images and extract 
metadata from their file names (i.e. channel, position, and time frame.)

The file list will be recognized by a specific regular expression (regex).
A regex matching these files can be `^(BF|TFP)_Position(\\d+)_time(\\d+).tif$`;
note that it has **3 capturing groups** (suff between parentheses).
The regex as a whole is used to select images from a directory (filtering out
other files) and the capturing groups are used to extract the metadata.

### Renaming Metamorph MDA images

Using Metamorph's _Multi-dimensional acquisition_ (MDA for short), may use file names different from the usual style (i.e `YFP_Position01_time1.tif`, and so on).

`rename_mda` will help you renaming those weird file names into something more useful.

It is provided in the `rcell2.cellid` package. A full example on how to use it is 
available in the packages notebook template.

## Load Cell-ID output

Cell-ID's output consists of segmented images, and data files in plain text format.
These must be loaded into R for further analyses.

This is done with the `load_cell_data` function:

```{r}
cell.data <- rcell2::load_cell_data(path = path)
```

Alternativley, there is also the `cell.load.alt` function from the `rcell2.cellid` package:

```{r}
cell.data <- rcell2.cellid::cell.load.alt(path = path,
                                          fluorescence.pattern = "^([GCYRT]FP)_Position\\d+.tif$")
```

> Obs: your `fluorescence.pattern` regex may vary, see `?cell.load.alt`.

### CellID variables help

Descriptions of the variables in `cdata` are available in the `rcell2.cellid` package:

```{r eval=F}
rcell2.cellid::cellid_output_descriptions(F)
```

### Check XY stage coordinates

It may be a good idea to double check that the physical coordinates of your images
match your expectations (i.e. the column/row pairs of each well in a microscopy plate).
This information is stored in TIFF's metadata.

With this information it is also possible to check whether the fields of view of
different positions overlap, inadvertently.

Code for this check iis available in the template notebook of the  `rcell2.magick` package.

Execute the following to install the package and open the template:

```{r}
if(!requireNamespace("rcell2.magick")) remotes::install_github("darksideoftheshmoo/rcell2-cellid")
rcell2.cellid::get_workflow_template_cellid()
```

## Data anlysis

The cell.data object is a list. The main dataset is stored in the `data` item, and
the paths to image files are in the `images` item.

We usually assign these to their own objects, for easier manipulation:

```{r}
cdata <- cell.data$data
images <- cell.data$images
```


### Tidy framework

- [ ] TODO: ¿donde puso los ejemplos/viñetas Ger para su tidy framework?

### Shiny-Magick framework

Extra tools for graphical filtering and annotation/tagging are available in 
the `rcell2.magick` package.

That package also includes functions for generating and manipulating
images of single cells, and preparing strips, tiles, and plots.

To learn more, install the `rcell2.magick` package and open it's template notebook.

Execute the following to install the package and open the template:

```{r}
if(!requireNamespace("rcell2.magick")) remotes::install_github("darksideoftheshmoo/rcell2-magick")
rcell2.magick::get_workflow_template_magick()
```

### Hu Moments

The Hu Moments can be computed from the masked TIFF files, generated by Cell-ID with 
the appropriate options (see `encode_cellID_in_pixels` and `fill_interior_pixels` in
the help page of `rcell2.cellid::cell2`).

To append the Hu Moments to a cell data object, use the `append_hues` function:

```{r}
cell_data <- rcell2::append_hues(cell_data = cell_data, 
                                 return_points = T, 
                                 image_bits = 16)

rcell2:::check_tiff_mask(cell_data)
```

Alternatively, the Hu Moments can be computed from the TSV files (see `output_coords_to_tsv`
at the help page of `rcell2.cellid::cell2`), by using the `append_hues2`.

Read its help page for more information:

```{r}
?append_hues2
```

