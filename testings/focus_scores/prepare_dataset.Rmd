---
title: "Medidas metricas o cosas que correlacionan bien con el foco"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_float:
      collapsed: false
    toc_depth: 2
    number_sections: false
    smooth_scroll: false
    code_folding: hide
  pdf_document:
    latex_engine: xelatex
    toc: true
    toc_depth: 2
    number_sections: true
editor_options:
  chunk_output_type: inline
author: NM
date: "`r format(Sys.time(), '%d %B, %Y')`"
urlcolor: blue
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "output/renders") })
---

## Libraries

`mmand` with examples: https://www.r-project.org/nosvn/pandoc/mmand.html

```{r}
# install.packages("mmand")
```


```{r setup, message=F}
knitr::opts_chunk$set(message = F)
knitr::opts_knit$set(root.dir = here::here())
# knitr::opts_chunk$set(cache = T)
devtools::load_all(reset = T)
library(utiles)
library(dplyr)
library(ggplot2)
# library(tidyr)
# library(purrr)
# library(plotly)
# library(renv)

library(magick)
```


## Parse Z-position

There is a tag in metamorph's tif: `<prop id="z-position" type="float" value="6716.22">`

```{r}
image.path <- 
  "/run/media/nicomic/ACLN1/ACL/Uscope/20210221_foco_calib_ACL379/BF_Position033.tif"
```

### Write function

```{r}
get_prop_values <- function(image.path, prop.id = "z-position"){
  
  image.info <- tiff::readTIFF(image.path, info = T, payload = F)

  # image.info %>% select(-description)
  
  description.xml <- xml2::read_xml(x = image.info$description)

  description.list <- xml2::as_list(description.xml)
  
  description.list$MetaData$PlaneInfo[3]
  
  description.list$MetaData$PlaneInfo[[3]] %>% attributes() %>% .[["id"]]
  
  which.z_info <- sapply(description.list$MetaData$PlaneInfo, function(plane.info){
    attributes(plane.info)[["id"]] == prop.id
  })
  
  # which.z_info <- which(which.z_info)[1] # keep the first one
  prop.values <- 
    sapply(which(which.z_info), function(which.z_info){
      prop.attributes <- description.list$MetaData$PlaneInfo[[which.z_info]] %>% attributes()
    
      prop.value <- as.numeric(prop.attributes$value)
    
      prop.value
    }) %>% unname()
  
  if(length(prop.values) > 1) warning(paste("Found more than one prop with id", prop.id))
  
  return(prop.values)
}
```

### test function

```{r}
get_prop_values(image.path, prop.id = "z-position")
```

### apply to all BFs

```{r}
image.paths <- dir("/run/media/nicomic/ACLN1/ACL/Uscope/20210221_foco_calib_ACL379/", pattern = "^BF.*tif$",
                   full.names = T)

image.paths <- setNames(image.paths, basename(image.paths))

z_positions <- sapply(image.paths, get_prop_values, prop.id = "z-position")

z_positions.df <- data.frame(BF = names(z_positions), zpos = unname(z_positions))

z_positions.df
```

### Save result

```{r}
# write.csv(z_positions.df, "/run/media/nicomic/ACLN1/ACL/Uscope/20210221_foco_calib_ACL379/zdata.csv")
```

```{r}
z_positions.df <- read.csv("/run/media/nicomic/ACLN1/ACL/Uscope/20210221_foco_calib_ACL379/zdata.csv")

plot(z_positions.df$zpos)
```

## Rename files for segmentation

```{r}
image.paths <- dir("/run/media/nicomic/ACLN1/ACL/Uscope/20210221_foco_calib_ACL379/", pattern = "^BF.*tif$",
                   full.names = T)
```

Puedo usar la 10 o la 33 como referencia de foco cero.

Cualquiera va:

```{r}
magick::image_read(image.paths[33]) %>% 
  magick::image_normalize() %>% 
  rcell2::magickForKnitr() %>% knitr::include_graphics()
magick::image_read(image.paths[10]) %>% 
  magick::image_normalize() %>% 
  rcell2::magickForKnitr() %>% knitr::include_graphics()
```

Si uso la 10, el desenfocado de 2um para segmentar es la primera imagen o la ultima.

Cualquiera va:

```{r}
magick::image_read(image.paths[1]) %>% 
  magick::image_normalize() %>% 
  rcell2::magickForKnitr() %>% knitr::include_graphics()

magick::image_read(image.paths[40]) %>% 
  magick::image_normalize() %>% 
  rcell2::magickForKnitr() %>% knitr::include_graphics()
```

```{r}
bf <- image.paths[40]
new.dir <- paste0(dirname(bf), 
                  "/images_renamed")

dir.create(new.dir)

new.dir
```


```{r}
positions <- 1:length(image.paths)
```


```{r}
bfs <- sapply(positions, function(pos){
  
  pos_string <- stringr::str_pad(pos, side = "left", width = 2, pad = 0)
  
  new_name <- paste0(
    new.dir, "/BF_Position", pos_string, ".tif"
  )
  
  file.symlink(from = bf, to = new_name)
  
  new_name
})
```


```{r}
tfps <- sapply(positions, function(pos){
  
  image.path <- image.paths[pos]
  
  pos_string <- stringr::str_pad(pos, side = "left", width = 2, pad = 0)
  
  new_name <- paste0(
    new.dir, "/TFP_Position", pos_string, ".tif"
  )
  
  file.symlink(from = image.path, to = new_name)
  
  new_name
})
```

## Run segmentation

```{r}
parameters.list <- rcell2::parameters.default()

parameters.list$background_reject_factor <-
  utiles::value.to.range(parameters.list$background_reject_factor, width = 0.5, by = 0.1)

parameters.df <- expand.grid(parameters.list)

# lapply(1:nrow(parameters.df), function(i){
#   parameters.list <- parameters.df[i,]
# })

parameters.list.one <- parameters.df[1,]

parameters.txt <- rcell2::parameters.write(parameters.list.one)
```


```{r}
new.dir <- "/run/media/nicomic/ACLN1/ACL/Uscope/20210221_foco_calib_ACL379/images_renamed"

cellid.args <- rcell2::arguments(new.dir,
                                 file.pattern = "^(BF|TFP)_Position(\\d+)().tif$",
                                 parameters = parameters.txt)

cellid.args
```

```{r}
cellid.args.one <- cellid.args[1,]

cellid.args.one
```

```{r}
rcell2::cell2(arguments = cellid.args.one, 
              cell.command = "~/Software/cellID-linux/cell", 
              output_coords_to_tsv = T)
```

